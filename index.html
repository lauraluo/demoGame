<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Phaser - Making your first game, part 3</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
    
    
<body>

<script type="text/javascript">

var game = new Phaser.Game(1500, 500, Phaser.AUTO, '', { preload: preload, create: create, update: update,render: render });


    
function preload() {
 
    game.load.image('block_miss_bed','assets/miss_bed.png');
    game.load.image('block_great','assets/great.png');
    game.load.image('block_miss_fed','assets/miss_fed.png');
    game.load.image('right_doll','assets/left.png');
    game.load.image('left_doll','assets/right.png');
    
    game.load.spritesheet('button', 'assets/button.png');

}
    
var bullets;
var bulletTime = 0;
var showDebug = true;
var blockＧreat;
var blockＭissFed;
var blockＭissBed;
var greatCunt = 0;
var missCunt = 0;
var popQueues = [];
var missText;
var greatText;
var button;
var pad;
var button;

    
function create() {
    
    var style = { size: "65px Arial", fill: "#ffffff", align: "center" };
    
    button = game.add.button(game.world.centerX - 95, 400, 'button', actionOnClick, this, 2, 1, 0);


    greatText = game.add.text(800, 100, "ＧREAT:0", style);
    missText = game.add.text(800, 180, "MISS:0", style);


    greatText.anchor.set(0.5);
    missText.anchor.set(0.5);

	blockＭissBed = game.add.sprite(100, 0, 'block_miss_bed');
	blockGreat = game.add.sprite(250, 0, 'block_great');
    game.physics.enable(blockGreat, Phaser.Physics.ARCADE);
	blockＭissFed = game.add.sprite(400, 0, 'block_miss_fed');
	bullet = game.add.sprite(1500, 200, 'right_doll');
	game.add.sprite(1500, 200, 'left_doll');

    
    
    
    
    bullets = game.add.group();
    bullets.enableBody = true;
    bullets.physicsBodyType = Phaser.Physics.ARCADE;
    bullets.createMultiple(1, 'right_doll');

    bullets.setAll('anchor.x', 0.5);
    bullets.setAll('anchor.y', 0.5);
    bullets.setAll('outOfBoundsKill', true);
    bullets.setAll('checkWorldBounds', true);
    console.log(bullets.children);
    for(var index in bullets.children){
        var _bullet = bullets.children[index];
        console.log(_bullet);
//        game.physics.arcade.overlap(blockGreat, _bullet, tagGreat, null);
        _bullet.events.onKilled.add(function(obj){
            obj.blockstatus = "";
            popQueues.shift();

        }, this);
    }
    

    
}

var actionOnClick = function(){
    if(popQueues.length > 0 ,popQueues[0] && popQueues[0].blockstatus == "great"){
        greatCunt++;
        console.log('great:'+greatCunt);
        popQueues[0].kill();

    }
};
    
var tagGreat = function(block, obj){    
    obj.blockstatus = "great";
    popQueues.push(obj);
    console.log("overlay");

};
    
var tagLost = function(block, obj){    
    obj.blockstatus = "lost"; 
};
    
var isValid = function(block, obj){
    console.log(block.x);
    console.log(block.width);
    console.log(obj.x);
    
    
    if(obj.x < block.x + block.width/2 && obj.x > block.x ){
        return true;
    }
    else if (obj.x <= block.x){
        missCunt++;
        console.log('miss:'+missCunt);
        popQueues[0].kill();
        return false;
    }
    else {
        return false;
    }
};

function update() {
    //fire
    if (game.time.now > bulletTime)
    {
        //  Grab the first bullet we can from the pool
        var bullet = bullets.getFirstExists(false);
        if (bullet)
        {
            //  And fire it
            bullet.reset(1500, 200);
            bullet.body.velocity.x = -1000;
            bulletTime = game.time.now + 800;
//            popQueues.push(bullet);
        }
    }
    
    game.physics.arcade.overlap(blockGreat, bullets.getFirstExists(true), tagGreat, isValid);
    
    if (game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR))
    {
        actionOnClick();
        
    }
    
    greatText.text = "GREAT:"+greatCunt;
    missText.text = "MISS:"+missCunt;

    
}
    
function render(){
 
}

</script>

</body>
</html>