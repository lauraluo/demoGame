<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE10" />
    <meta name="viewport" content="width=1024">

	<title>Phaser - Making your first game, part 3</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
    
    
<body>

<script type="text/javascript">

var game = new Phaser.Game(1000, 500, Phaser.AUTO, '', { preload: preload, create: create, update: update,render: render });


    
function preload() {
 
    game.load.image('block_miss_bed','assets/miss_bed.png');
    game.load.image('block_great','assets/great.png');
    game.load.image('block_miss_fed','assets/miss_fed.png');
    game.load.image('right_doll','assets/left.png');
    game.load.image('left_doll','assets/right.png');
    
    game.load.spritesheet('button', 'assets/button.png');
    
    game.load.audio('music', ['assets/music2.mp3','assets/music2.mp4','assets/music2.ogg']);

}
    
var bullets;
var bulletTime = 0;
var showDebug = true;
var blockＧreat;
var blockＭissFed;
var blockＭissBed;
var greatCunt = 0;
var missCunt = 0;
var popQueues = [];
var missText;
var greatText;
var button;
var pad;
var button;
var bulletObj;


    
function create() {
    
    var style = { size: "65px Arial", fill: "#ffffff", align: "center" };
    
    music = game.add.audio('music');
    music.play();
//    button = game.add.button(game.world.centerX + 95, 400, 'button', actionOnClick, this, 2, 1, 0);

    game.input.onDown.add(actionOnClick, this);

    greatText = game.add.text(800, 100, "ＧREAT:0", style);
    missText = game.add.text(800, 180, "MISS:0", style);


    greatText.anchor.set(0.5);
    missText.anchor.set(0.5);

	blockGreat = game.add.sprite(100, 0, 'block_great');
    game.physics.enable(blockGreat, Phaser.Physics.ARCADE);
//	blockＭissFed = game.add.sprite(400, 0, 'block_miss_fed');
	bulletObj = game.add.sprite(1250, 200, 'right_doll');
//	game.add.sprite(1024, 200, 'left_doll');
    
    bulletObj.scale.setTo(0.5, 0.5);
   
    bullets = game.add.group();
    bullets.enableBody = true;
    bullets.physicsBodyType = Phaser.Physics.ARCADE;
    bullets.createMultiple(100, 'right_doll');

    
    bullets.setAll('anchor.x', 0.5);
    bullets.setAll('anchor.y', 0.5);
    bullets.setAll('outOfBoundsKill', false);
    bullets.setAll('checkWorldBounds', true);
    
    for(var index in bullets.children){
        var _bullet = bullets.children[index];
//        console.log(_bullet);
//        game.physics.arcade.overlap(blockGreat, _bullet, tagGreat, null);
        _bullet.events.onKilled.add(function(obj){
            obj.blockstatus = "";
            popQueues.shift();

        }, this);
    }
    

    
}

var actionOnClick = function(obj){
//    console.log('click');
//    navigator.vibrate = navigator.vibrate ||
//    navigator.webkitVibrate ||
//    navigator.mozVibrate ||
//    navigator.msVibrate;
//
//    navigator.vibrate(1000);   
    
    if(popQueues.length > 0 ,popQueues[0] && popQueues[0].blockstatus == "great"){
        greatCunt++;
        popQueues[0].kill();

    }else if (popQueues.length > 0 ,popQueues[0] && popQueues[0].blockstatus == "miss"){
        missCunt++;
        popQueues[0].kill();
    }
};
    
var tagGreat = function(block, obj){    
//    obj.blockstatus = "great";
//    popQueues.push(obj);

};
    
var tagLost = function(block, obj){    
    obj.blockstatus = "lost"; 
};
    
var isValid = function(block, obj){
//    console.log(block.x);
//    console.log(block.width);
//    console.log(obj.x);
//    
    
    if(obj.x < block.x + 220 && obj.x > block.x +80 ){
        obj.blockstatus = "great";
        return true;
    }
    else if (obj.x >= block.x+220 ){
        obj.blockstatus = "miss";
        return false;
        
    }
    else if (obj.x <= block.x+80){
        missCunt++;
//        console.log('miss:'+missCunt);
        popQueues[0].kill();
        return false;
    }
    else {
        return false;
    }
};
var isfireInit = false;
var musicBeat = [1000,1000,1000,1000];
var fire = function(){
     if (game.time.now > bulletTime && isfireInit)
    {
        //  Grab the first bullet we can from the pool
        var bullet = bullets.getFirstExists(false);
        if (bullet)
        {
            //  And fire it
            bullet.reset(1250, 200);
            bullet.scale.setTo(0.8, 0.8);

            bullet.body.velocity.x = -1000;
            bulletTime = game.time.now +500; 
            popQueues.push(bullet);

        }
        
    }
    if(game.time.now > 300){
        isfireInit = true;   
    }
};

function update() {
    //fire
    fire();
    
//    game.physics.arcade.overlap(blockGreat, bullets, tagGreat, isValid);
    for(var index in popQueues){
        game.physics.arcade.overlap(blockGreat, popQueues[index], tagGreat, isValid);
    }
    
    greatText.text = "GREAT:"+greatCunt;
    missText.text = "MISS:"+missCunt;

    
}
    
function render(){
 
}

</script>

</body>
</html>